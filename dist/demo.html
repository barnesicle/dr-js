<!-- This html file is used as the template for how a client uses DigitalRiverPayments -->
<!-- DigitalRiver JS is injected into head by webpack<head>-->
<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8"/>
  <title>Client Page</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css"
        integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
  <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
  <style>
    .xsmall {
      font-size: 60%;
      margin: 0 20px;
    }

    #response {
      border: 1px solid deepskyblue;
      margin: 20px;
      padding: 20px;
      height: 80%;
      overflow: auto;
      overflow-wrap: break-word;
    }

    .ccIcons {
      color: #ddd;
      font-size: 2.3em;
      margin: -.5rem 0 .2rem 3px;
    }

    .ccIcons .active {
      color: #007bff;
    }

    #ccError, #expError, #cvvError {
      margin: -.5rem 0 .2rem 3px;
    }

    .DRElement {
      border:1px solid #ced4da;
      margin:0 0.2rem;
      border-radius:.25rem;
      overflow:hidden;
    }

    #apple-pay.DRElement,
    #google-pay.DRElement {
      border: none;
    }

    .custom--base, .myCustomBase2 {
      border:1px solid #ced4da;
      margin:0 0.2rem;
      border-radius:.25rem;
      overflow:hidden;
    }

    .DRElement--focus {
      border-color: #80bdff;
      outline: 0;
      box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }

    .custom--focus {
      border-color: #80bdff;
      background-color: rgba(128, 189, 255, 0.5);
      outline: 0;
      box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }

    .DRElement--invalid {
      border-color: #dc3545;
      outline: 0;
      box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.31);
    }

    .custom--invalid {
      border-color: #dc3545;
      background-color: rgba(220, 53, 69, 0.5);
      outline: 0;
      box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.31);
    }

    .DRElement--complete {
      border-color: #28a745;
      outline: 0;
      box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.31);
    }

    .custom--complete {
      border-color: #28a745;
      background-color: rgba(40, 167, 69, 0.51);
      outline: 0;
      box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.31);
    }

    .DRElement--empty {
      border-color: #db4518;
      outline: 0;
      box-shadow: 0 0 0 0.2rem rgba(219, 69, 24, 0.31);
    }

    .custom--empty {
      border-color: #db4518;
      background-color: rgba(219, 69, 24, 0.5);
      outline: 0;
      box-shadow: 0 0 0 0.2rem rgba(219, 69, 24, 0.31);
    }

    .DRElement--webkit-autofill {
      border-color: #4e20db;
      outline: 0;
      box-shadow: 0 0 0 0.2rem rgba(78, 32, 219, 0.31);
    }

    .custom--webkit-autofill {
      border-color: #4e20db;
      background-color: rgba(78, 32, 219, 0.5);
      outline: 0;
      box-shadow: 0 0 0 0.2rem rgba(78, 32, 219, 0.31);
    }
    #apple-pay {
      height: 42px;
    }
    #ibp {
      position:absolute;
      width: calc(100% - 32px);
      z-index:100;
      background-color: #fff;
    }
    .footer {
      color: white;
      background-color: black;
      height: 80px;
      margin-top: 80px;
      margin-bottom: 0;
    }
  </style>
<script type="text/javascript" src="DigitalRiver.js"></script></head>

<body class="bg-light" style="padding-top:50px;">
<div class="row">
  <div class="col-md-8">
    <div class="container">
      <div class="py-5 text-center">
        <h2>Checkout form</h2>
        <span style="color:red" id="message"></span>
        <p class="lead"></p>
      </div>
      <div class="row">
        <div class="col-md-4 order-md-2 mb-4">
          <h4 class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-muted">Your cart</span>
            <span class="badge badge-secondary badge-pill" id="cartQuantity">2</span>
          </h4>
          <ul class="list-group mb-3" id="cartItems">

            <!-- CART ITEMS GO HERE -->

            <div id="lineItems">
              <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                  <h6 class="my-0">Digital River Internet Security For PC</h6></div>
                <span class="text-muted">$23.99</span>
              </li>
              <li class="list-group-item d-flex justify-content-between lh-condensed">
                <div>
                  <h6 class="my-0">Digital River Laptop</h6></div>
                <span class="text-muted">$849.99</span>
              </li>
            </div>

            <li class="list-group-item d-flex justify-content-between" style="margin-top:30px;">
              <span>Subtotal</span>
              <strong id="subtotalWithoutDiscount">$873.98</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>Subtotal with Discount</span>
              <strong id="subtotalWithDiscountPrice">$873.98</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>Shipping</span>
              <strong id="shippingPrice">$5.00</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>Tax</span>
              <strong id="taxPrice">$35.16</strong>
            </li>
            <li class="list-group-item d-flex justify-content-between">
              <span>Total (USD)</span>
              <strong id="totalPrice">$914.14</strong>
            </li>
          </ul>
        </div>

        <div class="col-md-8 order-md-1">
          <div id="accordion">
            <div class="card">
              <div class="card-header" id="headingOne">
                <h5 class="mb-0">
                  <button class="btn btn-link" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true"
                          aria-controls="collapseOne">
                    Address Information
                  </button>
                  <div class="xsmall" id="addressInfo"></div>
                </h5>
              </div>

              <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-parent="#accordion">
                <div class="card-body">
                  <form class="needs-validation" novalidate="" id="address-form">
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label for="firstName">First name</label>
                        <input type="text" class="form-control" id="firstName" placeholder="" value="" required="">
                        <div class="invalid-feedback">
                          Valid first name is required.
                        </div>
                      </div>
                      <div class="col-md-6 mb-3">
                        <label for="lastName">Last name</label>
                        <input type="text" class="form-control" id="lastName" placeholder="" value="" required="">
                        <div class="invalid-feedback">
                          Valid last name is required.
                        </div>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label for="email">Email Address</label>
                      <input type="text" class="form-control" id="email" placeholder="example@example.com" required="">
                      <div class="invalid-feedback">
                        Please enter your email address.
                      </div>
                    </div>
                    <div class="mb-3">
                      <label for="email">Phone Number</label>
                      <input type="tel" class="form-control" id="phone" placeholder="9522253226" required="">
                      <div class="invalid-feedback">
                        Please enter your email address.
                      </div>
                    </div>
                    <div class="mb-3">
                      <label for="address">Address</label>
                      <input type="text" class="form-control" id="address" placeholder="1234 Main St" required="">
                      <div class="invalid-feedback">
                        Please enter your shipping address.
                      </div>
                    </div>
                    <div class="mb-3">
                      <label for="address2">Address 2 <span class="text-muted">(Optional)</span></label>
                      <input type="text" class="form-control" id="address2" placeholder="Apartment or suite">
                    </div>
                    <div class="mb-3">
                      <label for="country">Country</label>
                      <select class="custom-select d-block w-100" id="country" onchange="updateFields(this)" required="">
                        <option value="">Choose...</option>
                        <option value="US">US</option>
                        <option value="FR">FR</option>
                        <option value="DE">DE</option>
                        <option value="KR">KR</option>
                        <option value="JP">JP</option>
                      </select>
                      <div class="invalid-feedback">
                        Please select a valid country.
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-4 mb-3">
                        <label for="city">City</label>
                        <input type="text" class="form-control" id="city" placeholder="" required="">
                        <div class="invalid-feedback">
                          City is required.
                        </div>
                      </div>
                      <div class="col-md-4 mb-3">
                        <label for="state">State</label>
                        <select class="custom-select d-block w-100" id="state" required="">
                          <option value="">Choose...</option>
                          <optgroup label="US States">
                            <option value="AL">Alabama</option>
                            <option value="AK">Alaska</option>
                            <option value="AZ">Arizona</option>
                            <option value="AR">Arkansas</option>
                            <option value="CA">California</option>
                            <option value="CO">Colorado</option>
                            <option value="CT">Connecticut</option>
                            <option value="DE">Delaware</option>
                            <option value="DC">District Of Columbia</option>
                            <option value="FL">Florida</option>
                            <option value="GA">Georgia</option>
                            <option value="HI">Hawaii</option>
                            <option value="ID">Idaho</option>
                            <option value="IL">Illinois</option>
                            <option value="IN">Indiana</option>
                            <option value="IA">Iowa</option>
                            <option value="KS">Kansas</option>
                            <option value="KY">Kentucky</option>
                            <option value="LA">Louisiana</option>
                            <option value="ME">Maine</option>
                            <option value="MD">Maryland</option>
                            <option value="MA">Massachusetts</option>
                            <option value="MI">Michigan</option>
                            <option value="MN">Minnesota</option>
                            <option value="MS">Mississippi</option>
                            <option value="MO">Missouri</option>
                            <option value="MT">Montana</option>
                            <option value="NE">Nebraska</option>
                            <option value="NV">Nevada</option>
                            <option value="NH">New Hampshire</option>
                            <option value="NJ">New Jersey</option>
                            <option value="NM">New Mexico</option>
                            <option value="NY">New York</option>
                            <option value="NC">North Carolina</option>
                            <option value="ND">North Dakota</option>
                            <option value="OH">Ohio</option>
                            <option value="OK">Oklahoma</option>
                            <option value="OR">Oregon</option>
                            <option value="PA">Pennsylvania</option>
                            <option value="RI">Rhode Island</option>
                            <option value="SC">South Carolina</option>
                            <option value="SD">South Dakota</option>
                            <option value="TN">Tennessee</option>
                            <option value="TX">Texas</option>
                            <option value="UT">Utah</option>
                            <option value="VT">Vermont</option>
                            <option value="VA">Virginia</option>
                            <option value="WA">Washington</option>
                            <option value="WV">West Virginia</option>
                            <option value="WI">Wisconsin</option>
                            <option value="WY">Wyoming</option>
                          </optgroup>
                          <optgroup label="France States">
                            <option value="Ile-de-France">Île-de-France</option>
                          </optgroup>
                          <optgroup label="Korean States">
                            <option value="Jeju Do">Jeju Do</option>
                          </optgroup>
                          <optgroup label="Japan States">
                            <option value="Tokyo">Tokyo</option>
                            <option value="Kyongsangnamdo">Kyongsangnamdo</option>
                          </optgroup>
                        </select>
                        <div class="invalid-feedback">
                          Please provide a valid state.
                        </div>
                      </div>
                      <div class="col-md-3 mb-3">
                        <label for="zip">Zip</label>
                        <input type="text" class="form-control" id="zip" placeholder="" required="">
                        <div class="invalid-feedback">
                          Zip code required.
                        </div>
                      </div>
                    </div>
                    <hr class="mb-4">
                    <div class="custom-control custom-checkbox">
                      <input type="checkbox" class="custom-control-input" id="same-address" checked="">
                      <label class="custom-control-label" for="same-address">Shipping address is the same as my billing
                        address</label>
                    </div>
                    <div class="custom-control custom-checkbox">
                      <input type="checkbox" class="custom-control-input" id="save-info">
                      <label class="custom-control-label" for="save-info">Save this information for next time</label>
                    </div>
                    <hr class="mb-4">
                    <input type="hidden" id="phoneNumber">
                    <button class="btn btn-primary btn-lg btn-block" onclick="addAddress(event)" type="submit">Add Address
                    </button>
                  </form>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-header" id="headingTwo">
                <h5 class="mb-0">
                  <button id="paymentLink" class="btn btn-link collapsed" data-toggle="collapse"
                          data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                    Payment Information
                  </button>
                  <div class="xsmall" id="paymentInfo"></div>
                </h5>
              </div>
              <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordion">
                <div class="card-body">
                  <div class="row">
                    <div id="apple-pay" class="col-md-6 mb-3">
                      <!--apple pay loads here-->
                    </div>
                  </div>

                  <form id="payment-form">
                    <div class="row" id="creditCardPanel">
                      <div class="col-md-6 mb-3 paymentElement">
                        <label>Credit Card Number</label>
                        <div id="ccError" class="text-danger"><!--error messages will go here--></div>
                        <div class="ccIcons">
                          <i id="visa" class="fab fa-cc-visa"></i>
                          <i id="mastercard" class="fab fa-cc-mastercard"></i>
                          <i id="amex" class="fab fa-cc-amex"></i>
                          <i id="discover" class="fab fa-cc-discover"></i>
                          <i id="jcb" class="fab fa-cc-jcb"></i>
                          <i id="dinersclub" class="fab fa-cc-diners-club"></i>
                        </div>
                        <div id="cardnumber" class="myCustomClass"></div>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-6 mb-3 paymentElement">
                        <label>Expiration Date</label>
                        <div id="expError" class="text-danger"><!--error messages will go here--></div>
                        <div id="cardexpiration" class="myCustomClass"></div>
                      </div>
                      <div class="col-md-6 mb-3 paymentElement">
                        <label>CVV</label>
                        <div id="cvvError" class="text-danger"><!--error messages will go here--></div>
                        <div id="cardcvv" class="myCustomClass"></div>
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-md-12 mb-3 paymentElement">
                        <div id="google-pay"></div>
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-md-12 mb-3 paymentElement">
                        <div id="paypal-btn"></div>
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-md-12 mb-3 paymentElement">
                        <button id="ddButton" class="btn btn-primary btn-lg btn-block" type="submit" onclick="ddGetSource()">Pay with Direct Debit (FR)
                        </button>
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-md-12 mb-3 paymentElement">
                        <button id="wtButton" class="btn btn-primary btn-lg btn-block" type="submit" onclick="wtGetSource()">Pay with Wire Transfer
                        </button>
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-md-12 mb-3 paymentElement">
                        <button id="paycoButton" class="btn btn-primary btn-lg btn-block" type="submit" onclick="commonGetSource('payco','KRW')">Pay with Payco (Korea)
                        </button>
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-md-12 mb-3 paymentElement">
                        <button id="japanCODButton" class="btn btn-primary btn-lg btn-block" type="submit" onclick="commonGetSource('codJapan', 'JPY')">Pay with Japan COD
                        </button>
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-md-12 mb-3 paymentElement">
                        <div id="ibp">
                          <div id="ibpbanks"></div>
                        </div>
                      </div>
                    </div>

                    <hr class="mb-4">
                    <button id="addPaymentButton" class="btn btn-primary btn-lg btn-block" type="submit" onclick="addPayment()">Add Payment
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div id="source" style="display:none"></div>
            <div id="card-errors"></div>
          </div>
          <div class="row" id="submitPayment">
            <div class="col-md-12">
              <br/>
              <button id="submitPaymentButton" class="btn btn-primary btn-lg btn-block" onclick="submitCreditCardPayment()">Submit CC Payment</button>
              <button id="submitIBPPaymentButton" class="btn btn-primary btn-lg btn-block" onclick="submitIbpPayment()">Submit IBP Payment</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <button onclick="creditCardNumberComponent.clear()">clear ccnum</button>
    <button onclick="creditCardNumberComponent.focus(); setTimeout(function() {creditCardNumberComponent.blur()}, 2000)">focus ccnum, then blur</button>
    <button onclick="ibpBanksComponent.focus(); setTimeout(function() {ibpBanksComponent.blur()}, 2000)">focus ibp, then blur</button>
    <button onclick="creditCardNumberComponent.update({placeholderText: 'Number', classes: {base:'myCustomBase2'}, style: { base: {'::placeholder': {color:'red'}}, complete: {color: 'white'}}})">update ccnum options</button>
    <button onclick="creditCardNumberComponent.update({style: { base: {'::placeholder': {color:'green'}}}})">update ccnum again</button>
    <button onclick="creditCardNumberComponent.unmount();">unmount ccnum</button>
    <button onclick="creditCardNumberComponent.mount('cardnumber');">remount ccnum</button>
    <button onclick="creditCardNumberComponent.destroy()">destroy ccnum</button>
    <div>
      <button onclick="applePayComponent.show()">show applepay sheet</button>
      <button onclick="applePayComponent.update(updatedAppleInfo)">update applePay</button>
      <button onclick="googlePayComponent.show()">show googlepay sheet</button>
      <button onclick="googlePayComponent.update(googlePayUpdatePaymentRequest)">googlepay update</button>
    </div>
    <div>
      <button onclick="destroyField()">Remove Card Number field</button>
      <button onclick="recreateField()">Re-create Card Number field</button>
    </div>
  </div>

  <div class="col-md-4 console">
    <pre id="response"></pre>
  </div>
</div>
<div class="footer">

</div>
<script src="https://www.paypalobjects.com/api/checkout.js"></script>
<script type="text/javascript">
  let apiKey = 'pk_hc_8e3f70c75f314c46855e840ba7a8baab';
  let digitalRiverPayments;
  let owner = {};
  let response = document.getElementById('response');

  let creditCardNumberComponent;
  let creditCardExpiryComponent;
  let creditCardCvvComponent;
  let googlePayComponent;
  let applePayComponent;
  let ibpBanksComponent;

  let googlePayPaymentRequest;
  let googlePayUpdatePaymentRequest;

  let updatedAppleInfo;
  let paypalSourceId;

  let ccNumComplete = false;
  let ccExpirationComplete = false;
  let ccCVVComplete = false;

  let styles = {
    base: {
      color: '#495057',
      height: '35px',
      fontSize: '1rem',
      fontFamily: 'apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif',
      // fontWeight: 'lighter',
      ':hover': {
        color: '#137bee',
      },
      '::placeholder': {
        color: '#999'
      },
      ':-webkit-autofill': {
        color: 'purple'
      },
      ':focus': {
        color: 'blue'
      }
    },
    invalid: {
      color: '#dc3545',
      ':-webkit-autofill': {
        color: '#dc3545'
      }
    },
    complete: {
      color: '#28a745',
      ':hover': {
        color:'#28a745',
      },
      ':-webkit-autofill': {
        color: '#28a745'
      }
    },
    empty: {
      color: '#db4518',
      ':hover': {
        color: '#db4518'
      },
      '::placeholder': {
        color: '#db4518'
      }
    },

  };

  let ccNumOptions = {
    placeholderText: 'Credit Card Number',
    style: styles,
    classes: {
      base: 'custom--base',
      focus: 'custom--focus',
      invalid: 'custom--invalid',
      empty: 'custom--empty',
      complete: 'custom--complete',
      webkitAutofill: 'custom--webkit-autofill'
    }
  };

  function mockFetch() {
    return new Promise(function(resolve) {
      setTimeout(function() {
        resolve();
      }, 1000);
    });
  }

  function getDefaultGooglePayData() {

    const lineItems = [
      {
        label: "Some Product",
        amount: 10,
        isPending: false
      },
      {
        label: "Discount (20% off)",
        amount: 5,
        isPending: false
      },
      {
        label: "Sales Tax",
        amount: 3,
        isPending: true
      }
    ];

    const shippingOptions = [
      {
        id: "free-shipping",
        label: "Free Shipping",
        amount: 0,
        detail: "Will arrive in a few days"
      },
      {
        id: "overnight-shipping",
        label: "Overnight Shipping",
        amount: 10,
        detail: "Will arrive tomorrow morning"
      }
    ];

    return {
      country: "us",
      currency: "USD",
      total: {
        label: "Order Total",
        amount: 6.20,
        isPending: true
      },
      displayItems: lineItems,
      shippingOptions: shippingOptions,
      requestShipping: true,
      style: {
        buttonType: "plain",
        buttonColor: "light",
        buttonLanguage: "en"
      },
      waitOnClick: true
    };

  }

  function onLoad() {
    var isIE = !!window.MSInputMethodContext && !!document.documentMode;
    console.log(isIE);
    if(navigator.userAgent.indexOf('MSIE')!==-1
            || navigator.appVersion.indexOf('Trident/') > -1){
      isIE = true;
      /* Microsoft Internet Explorer detected in. */
    }
    if(!isIE) {
      let urlParams = new URLSearchParams(window.location.search);

      if(urlParams.get('sourceId')) {
        responseLog('Shopper has returned from redirect. <br/> sourceId ' + urlParams.get('sourceId') + ' can now be used for payment');
      }

    }

    const options = { 'locale': 'es-CO'};
    digitalRiverPayments = new DigitalRiver(apiKey, options);

    let updatedccNumOptions = {
      placeholderText: 'Number',
      style: styles
    };
    let ccExpirationOptions = {
      placeholderText: 'MM/YY',
      style: styles
    };
    let ccCVVOptions = {
      placeholderText: 'CVV',
      style: styles
    };

    googlePayPaymentRequest = digitalRiverPayments.paymentRequest(getDefaultGooglePayData());

    const googlePayUpdateData = getDefaultGooglePayData();

    googlePayUpdateData.style.buttonType = 'long';
    googlePayUpdateData.style.buttonColor = 'dark';
    googlePayUpdateData.style.buttonLanguage = 'de';
    googlePayUpdateData.total.label = 'Order Total - from update call';
    googlePayUpdateData.waitOnClick = true;
    googlePayUpdatePaymentRequest = googlePayUpdateData;

    const shippingOptions = [
      {
        id: "free-shipping",
        label: "Free Shipping",
        amount: 0,
        detail: "Will arrive in a few days",
        // added selected attribute as string instead of boolean to verify DR js converting them to boolean.
        selected: "true"
      },
      {
        id: "ground",
        label: "Ståndard Shipping",
        amount: 5,
        detail: "Will arrive in a few days",
        selected: true
      },
      {
        id: "overnight-shipping",
        label: "Overnîght Shipping",
        amount: 10,
        detail: "Will arrive tomorrow morning",
        // added selected attribute as string instead of boolean to verify DR js converting them to boolean.
        selected: "false"
      }
    ];

    const applePayPaymentRequest = digitalRiverPayments.paymentRequest({
      country: "us",
      currency: "USD",
      total: {
        label: "Your Order Total",
        amount: 1,
        isPending: false
      },
      displayItems: [
        {
          label: "Subtotal",
          amount: 1,
          isPending: false
        },
        {
          label: "Shipping",
          amount: 0,
          isPending: false
        }
      ],
      //shippingOptions: shippingOptions,
      requestShipping: false,
      style: {
        buttonType: "plain",
        buttonColor: "dark",
        buttonLanguage: "en"
      },
      waitOnClick: true
    });

    updatedAppleInfo = {
      total: {
        label: "Order Total after update",
        amount: 2,
        isPending: false
      },
      displayItems: [
        {
          label: "subtotal after update",
          amount: 1,
          isPending: false
        },
        {
          label: "shipping after update",
          amount: 0,
          isPending: false
        }
      ],
      style: {
        buttonType: "buy",
        buttonColor: "light",
        buttonLanguage: "fr"
      }
    };

    document.getElementById('addPaymentButton').setAttribute("disabled", "disabled");

    console.log(googlePayPaymentRequest);
    console.log(applePayPaymentRequest);

    // Initialize DRP library
    creditCardExpiryComponent = digitalRiverPayments.createElement('cardexpiration', ccExpirationOptions);
    creditCardCvvComponent = digitalRiverPayments.createElement('cardcvv', ccCVVOptions);

    ibpBanksComponent = digitalRiverPayments.createElement('onlinebanking', {
      style: styles,
      onlineBanking: { currency: 'EUR', country: 'DE' },
      placeholderText: 'Select a bank'
    });

    googlePayComponent = digitalRiverPayments.createElement('googlepay', googlePayPaymentRequest);
    applePayComponent = digitalRiverPayments.createElement('applepay', applePayPaymentRequest);


    console.log('Calling mount functions');

    creditCardExpiryComponent.mount("cardexpiration");
    creditCardCvvComponent.mount("cardcvv");
    ibpBanksComponent.mount('ibpbanks');

    if (googlePayComponent.canMakePayment()) {
      googlePayComponent.mount("google-pay");

      googlePayComponent.on('ready', function(event) {
        responseLog('googlepay ready received ' + JSON.stringify(event));
      });

      googlePayComponent.on('click', function(details) {
        console.log('google pay click')
        responseLog('googlepay click received ' + JSON.stringify(details));
        const updatedDetailsData = {
          total: {
            label: 'Order Total - click event with wait'
          },
          shippingOptions: shippingOptions
        };

        if (details.updateWith) {
          console.log('updateWith google function')
          mockFetch('https://chrismiller1.free.beeceptor.com/') // Call the fetch function passing the url of the API as a parameter
                  .then(function(data) {
                    // Your code for handling the data you get from the API
                    if(details.hasOwnProperty('updateWith')) {
                      details.updateWith(updatedDetailsData)
                    }
                  })
        }
      });

      googlePayComponent.on("source", function (data) {
        responseLog('googlepay source received ' + JSON.stringify(data));
        data.complete('success');
      });

      googlePayComponent.on("shippingaddresschange", function (details) {
        responseLog('googlepay shippingaddresschange received ' + JSON.stringify(details));

        const data = {};
        if (details.shippingAddress.address.country === 'US') {
          data.total = {label: 'Order Total - address change - success'};
          data.shippingOptions = [
            {
              id: "ground",
              label: "Standard Shipping",
              amount: 5,
              detail: "Will arrive in a few days"
            },
            {
              id: "priority-mail-shipping",
              label: "Priority Mail Shipping",
              amount: 10,
              detail: "Will arrive 1-3 days"
            },
            {
              id: "overnight-shipping",
              label: "Overnight Shipping",
              amount: 25,
              detail: "Will arrive tomorrow morning"
            }
          ];
          data.status = 'success';
        } else { // Error!
          data.total = {label: 'Order Total - address change - error'};
          data.status = 'failure';
          data.error = {
            message: "You can only ship to a US address.",
            fields: {
              country: 'Invalid country',
              city: 'Woops. Bad city'
            }
          };
        }

        if (details.updateWith) {
          setTimeout(function () {
            details.updateWith(data)
          }, 1000);
        }
      });

      googlePayComponent.on("shippingoptionchange", function (details) {
        responseLog('googlepay shippingoptionchange received ' + JSON.stringify(details));
        const data = {total : {label: 'Order Total - option change'}};
        data.shippingOptions = [
          {
            id: "ground",
            label: "Standard Shipping",
            amount: 5,
            detail: "Will arrive in a few days"
          },
          {
            id: "priority-mail-shipping",
            label: "Priority Mail Shipping",
            amount: 10,
            detail: "Will arrive 1-3 days"
          }
        ];
        setTimeout(function () {details.updateWith(data)}, 1000);
      });

      googlePayComponent.on('cancel', function(event) {
        responseLog('googlepay session was canceled ' + JSON.stringify(event));
      });

    }

    if (applePayComponent.canMakePayment()) {
      applePayComponent.mount("apple-pay");
    } else {
      document.getElementById('apple-pay').setAttribute('style','display:none');
    }

    applePayComponent.on('shippingaddresschange', function(details) {
      responseLog('applepay shipping address was updated');
      responseLog(JSON.stringify(details));
      setTimeout(function () {
        let updatedDetails = {
          status: 'success',
          shippingOptions: [
            {
              id: "free-shipping 2 ",
              label: "Free Shipping 2",
              amount: 0,
              detail: "Will arrive in a few days",
              selected: true
            },
            {
              id: "overnight-shipping 2",
              label: "Óvêrnight ShiÞþing 2",
              amount: 10,
              detail: "Will arrive tomorrow morning"
            }
          ],
          total: updatedAppleInfo.total,
          style: {
            buttonType: "buy",
            buttonColor: "light",
            buttonLanguage: "fr"
          }
        };
        //failure scenario with error block
        if(details.shippingAddress.address.city === 'Apple Valley') {
          updatedDetails.status = 'failure';
          updatedDetails.error = {
            message: 'An Error has occurred.  Please try again.',
            fields: {
              postalCode: 'Your zip code is crazy bad'
            }
          };
        }

        //failure scenario and error not sent (checking defaults)
        if(details.shippingAddress.address.city === 'Kaladim') {
          updatedDetails.status = 'failure';
        }
        responseLog('sending info back to DR for Apple');
        responseLog(JSON.stringify(updatedDetails));
        fetch('https://jsonplaceholder.typicode.com/todos/1') // Call the fetch function passing the url of the API as a parameter
                .then(function() {
                  // Your code for handling the data you get from the API
                  if(details.hasOwnProperty('updateWith')) {
                    details.updateWith(updatedDetails)
                  };
                })
      }, 2000);
    });
    applePayComponent.on('shippingoptionchange', function(details) {
      responseLog('applepay shipping option was updated');
      responseLog(JSON.stringify(details));
      setTimeout(function () {
        let updatedDetails = {
          status: 'success',
          total: {
            label: "Order Total",
            amount: 3,
            isPending: false
          },
          displayItems: [
            {
              label: "subtotal after shipping method change",
              amount: 3,
              isPending: false
            },
            {
              label: "shipping",
              amount: 0,
              isPending: false
            }
          ]
        };
        fetch('https://jsonplaceholder.typicode.com/todos/1') // Call the fetch function passing the url of the API as a parameter
                .then(function(data) {
                  // Your code for handling the data you get from the API
                  console.log(data);
                  if(details.hasOwnProperty('updateWith')) {
                    console.log('client sending updated shipping option info')
                    details.updateWith(updatedDetails);
                  };
                })
        responseLog('sending info back to DR for Apple');
        responseLog(JSON.stringify(updatedDetails));
      }, 2000);

    });

    applePayComponent.on('ready', function(event) {
      responseLog('applepay ready received ' + JSON.stringify(event));
    });

    applePayComponent.on('click', function(event) {
      responseLog('applepay button was clicked');
      responseLog(JSON.stringify(event));
      setTimeout(function () {
        let updatedDetails = {
          status: 'success',
          displayItems: [
            {
              label: "Subtotal",
              amount: 1,
              isPending: false
            },
            {
              label: "Shipping",
              amount: 1,
              isPending: false
            }
          ],
        };
        // Call the fetch function passing the url of the API as a parameter
        fetch('https://jsonplaceholder.typicode.com/todos/1').then(function(data) {
          // Your code for handling the data you get from the API
          console.log(data);
          if(event.hasOwnProperty('updateWith')) {
            console.log('client sending updated info');
            event.updateWith(updatedDetails);
          };
        });
        responseLog(JSON.stringify(updatedDetails));
      }, 2000);
    });

    applePayComponent.on('cancel', function(event) {
      responseLog('applepay session was canceled');
      responseLog(JSON.stringify(event));
    });

    applePayComponent.on('source', function(event) {
      responseLog('applepay source was created');
      responseLog(JSON.stringify(event));
      event.complete('success');
    });

    // Credit Card Number Listeners
    // this is demonstrating that the client is receiving the event for now.
    creditCardEvents();

    // Credit Card Expiry Listeners
    creditCardExpiryComponent.on('ready', function (event) {
      responseLog('expiration ready received ' + JSON.stringify(event) + ' for ' + event.elementType);
    });

    creditCardExpiryComponent.on('blur', function (event) {
      responseLog('expiration blur received ' + JSON.stringify(event) + ' for ' + event.elementType);
    });

    creditCardExpiryComponent.on('focus', function (event) {
      responseLog('expiration focus received ' + JSON.stringify(event) + ' for ' + event.elementType);
    });

    creditCardExpiryComponent.on('change', function (event) {
      responseLog('expiration change received ' + JSON.stringify(event) + ' for cardexpiration');

      const errorDiv = document.getElementById('expError');
      displayValidation(event, errorDiv, 'Expiration Date');

      ccExpirationComplete = event.complete;
      checkFormComplete();
    });

    // Cred Card Security Code Listeners
    creditCardCvvComponent.on('ready', function (event) {
      responseLog('cvv ready received ' + JSON.stringify(event) + ' for ' + event.elementType);
    });

    creditCardCvvComponent.on('blur', function (event) {
      responseLog('cvv blur received ' + JSON.stringify(event) + ' for ' + event.elementType);
    });

    creditCardCvvComponent.on('focus', function (event) {
      responseLog('cvv focus received ' + JSON.stringify(event) + ' for ' + event.elementType);
    });

    creditCardCvvComponent.on('change', function (event) {
      responseLog('cvv change received ' + JSON.stringify(event) + ' for cardcvv');

      const errorDiv = document.getElementById('cvvError');
      displayValidation(event, errorDiv, 'CVV');

      ccCVVComplete = event.complete;
      checkFormComplete();
    });

    ibpBanksComponent.on('ready', function (event) {
      responseLog( event.elementType + ' ready received ' + JSON.stringify(event) + ' for ' + event.elementType);
    });

    ibpBanksComponent.on('blur', function (event) {
      responseLog(event.elementType + ' blur received ' + JSON.stringify(event) + ' for ' + event.elementType);
    });

    ibpBanksComponent.on('focus', function (event) {
      responseLog(event.elementType + ' focus received ' + JSON.stringify(event) + ' for ' + event.elementType);
    });

    ibpBanksComponent.on('change', function (event) {
      responseLog(event.elementType + ' change received ' + JSON.stringify(event) + ' for ' + event.elementType);
    });

    // PayPal Button
    payPalBtn(digitalRiverPayments);

  }

  window.onload = onLoad;

  function payPalBtn(digitalRiverPayments) {

    let paypalSourceData = {
      type:'payPal',
      amount: 914.14,
      currency: 'USD',
      payPal: {
        returnUrl : 'https://js-test.digitalriver.com/v1/demo.html',
        cancelUrl: 'https://js-test.digitalriver.com/v1/demo.html',
        items: [
          {
            name: 'Digital River Internet Security for PC',
            quantity: 1,
            unitAmount: '23.99',
          },
          {
            name: 'Digital River Laptop',
            quantity: 1,
            unitAmount: '849.99'
          }
        ],
        taxAmount: 35.16,
        requestShipping: true,
        amountEstimated: true,
        // Optional Attributes
        shippingAmount: 5,
        shipping:{
          recipient: 'Test Data',
          phoneNumber: '9522251234',
          address: {
            line1: '10380 Bren Road West',
            line2: '',
            city: 'Minnetonka',
            state: 'MN',
            country: 'US',
            postalCode: '55343'
          }
        }
      }
    }

    paypal.Button.render({
      // Configure environment
      env: 'sandbox',
      locale: 'en_US',
      style: {
        label: 'checkout',
        size: 'responsive',
        color: 'gold',
        shape: 'pill',
        layout: 'horizontal',
        fundingicons: 'false'
      },
      // Set up a payment
      payment: function (data, actions) {
        return digitalRiverPayments.createSource(paypalSourceData).then(function (result) {
          responseLog('payPal create source ' + JSON.stringify(result));
          paypalSourceId = result.source.id;
          return result.source.payPal.token;
        });
      },
      // Execute the payment
      onAuthorize: function (data, actions) {
        let source = {
          sourceId: paypalSourceId
        }
        responseLog('payPal success ' + JSON.stringify(data)+','+ JSON.stringify(source));
      }
    }, '#paypal-btn');
  }

  function creditCardEvents() {
    creditCardNumberComponent = digitalRiverPayments.createElement('cardnumber', ccNumOptions);
    creditCardNumberComponent.mount("cardnumber");

    creditCardNumberComponent.on('ready', function (event) {
      responseLog('ccnum ready received ' + JSON.stringify(event) + ' for ' + event.elementType);
    });

    creditCardNumberComponent.on('blur', function (event) {
      responseLog('ccnum blur received ' + JSON.stringify(event) + ' for ' + event.elementType);
    });

    creditCardNumberComponent.on('focus', function (event) {
      responseLog('ccnum focus received ' + JSON.stringify(event) + ' for ' + event.elementType);
    });

    creditCardNumberComponent.on('change', function (event) {
      responseLog('ccnum change received ' + JSON.stringify(event) + ' for cardnumber');
      highlightCCIcon(event.brand);

      const errorDiv = document.getElementById('ccError');
      displayValidation(event, errorDiv, 'Credit Card');

      ccNumComplete = event.complete;
      checkFormComplete();
    });
  }

  function responseLog(msg) {
    response.innerHTML += msg + '<br/><br/>';
  }

  function highlightCCIcon(brand) {
    const ccIcons = document.querySelectorAll('.ccIcons .fab');
    for(let i = 0; i < ccIcons.length; i++) {
      let icon = document.getElementById(ccIcons[i].id);
      if(icon.id === brand) {
        icon.classList.add('active');
      } else {
        icon.classList.remove('active');
      }
    }
  }

  function displayValidation(event, errorDiv, fieldName) {
    if(event.error) {
      let errorText = '';
      switch(event.error.code) {
        case 'ELEMENT_DATA_REQUIRED':
          errorText = 'This field is required';
          break;
        case 'ELEMENT_DATA_INCOMPLETE':
          errorText = 'Invalid length for ' + fieldName;
          break;
        case 'ELEMENT_DATA_INVALID':
          errorText = 'Invalid ' + fieldName;
          break;
        case 'ELEMENT_DATA_DATE_IN_PAST':
          errorText = 'Date must be a future date';
          break;
        case 'ELEMENT_DATA_INVALID_MONTH':
          errorText = 'Invalid Month';
          break;
        case 'ELEMENT_DATA_INVALID_NUMBER':
          errorText = 'Card number must be valid';
          break;
        default:
          errorText = event.error.message;
      }
      errorDiv.innerText = errorText;
    } else {
      errorDiv.innerText = '';
    }
  }

  function checkFormComplete() {
    if(ccNumComplete && ccExpirationComplete && ccCVVComplete) {
      document.getElementById('addPaymentButton').removeAttribute("disabled");
    } else {
      document.getElementById('addPaymentButton').setAttribute("disabled", "disabled");
    }
  }

  function addAddress(event) {
    event.preventDefault();
    document.getElementById('paymentLink').click();
    let address = document.getElementById('address-form');
    owner.firstName = address.firstName.value;
    owner.lastName = address.lastName.value;
    owner.email = address.email.value;
    owner.phoneNumber = address.phone.value;
    owner.address = {
      "line1": address.address.value,
      "line2": address.address2.value || '',
      "city": address.city.value,
      "state": address.state.value,
      "country": address.country.value,
      "postalCode": address.zip.value
    };

    document.getElementById('addressInfo').innerHTML = (
            owner.firstName + ' ' + owner.lastName
            + '<br/>'
            + owner.address.line1 + ' ' + owner.address.line2 + '<br/>'
            + owner.address.city + ' ' + owner.address.state + ' ' + owner.address.postalCode
    );

    response.innerHTML += 'gathering user\'s address info...<br/>'

  }

  function addPayment() {
    // right now this just collapses and then displays the submit payment button
    event.preventDefault();
    document.getElementById('paymentLink').click();
    $('#submitPayment').show();
    response.innerHTML += 'gathering user\'s payment info...<br/>'
  }

  function submitCreditCardPayment() {
    // Call CreateSource
    const payload = {
      "type": "creditCard",
      "usage": "single",
      "owner": owner,
      "amount": 100,
      "currency": "USD"
    };

    document.getElementById("response").innerHTML += "Submitting Credit Card payment...please wait<br/>";
    digitalRiverPayments.createSource(creditCardNumberComponent, payload).then( function(response) {
      if(response.error) {
        document.getElementById("response").innerHTML += "Credit Card Payment response received error message: " + response.error.code + "" + JSON.stringify(response, null, '\t');
      } else {
        document.getElementById("response").innerHTML += "Credit Card Payment response: " + "" + JSON.stringify(response.source, null, '\t');
      }
    }).catch(function (err)  {
      console.error('createSource failed:', err);
    });
  }

  function submitIbpPayment() {
    // Call CreateSource
    const payload = {
      "type": "onlineBanking", // TODO
      "usage": "single",
      "owner": owner,
      "amount": 100,
      "currency": "EUR",
      "onlineBanking" : {
        "returnUrl" : window.location.href,
        "cancelUrl" : window.location.href,

      }
    };

    document.getElementById("response").innerHTML += "Submitting IBP payment...please wait<br/>";
    digitalRiverPayments.createSource(ibpBanksComponent, payload).then( function(response) {
      if(response.error) {
        document.getElementById("response").innerHTML += "IBP Payment response received error message: " + response.error.code + "" + JSON.stringify(response, null, '\t');
      } else {
        document.getElementById("response").innerHTML += "IBP Payment response: " + "" + JSON.stringify(response.source, null, '\t');
      }
    }).catch(function (err) {
      console.error('createSource failed:', err);
    });
  }

  function ddGetSource() {
    event.preventDefault();
    const payload = {
      "type": "directDebit",
      "owner": owner,
      "amount": 100,
      "currency": "EUR",
      "directDebit": {
        "returnUrl": window.location.href
      }
    };

    digitalRiverPayments.createSource(payload).then( function(response) {
      if(response.error) {
        document.getElementById("response").innerHTML += "Payment response received error message: " + response.error.code + "" + JSON.stringify(response, null, '\t');
      } else {
        document.getElementById("response").innerHTML += "Payment response: " + "" + JSON.stringify(response.source, null, '\t');
        var ddWindow = window.open(response.source.redirect.redirectUrl, 'directDebit');
      }
    }).catch(function (err) {
      console.error('createSource failed:', err);
    });
  }

  function wtGetSource() {
    event.preventDefault();
    const payload = {
      "type": "wireTransfer",
      "owner": owner,
      "amount": 100,
      "currency": "USD",
      "wireTransfer": {}
    };

    digitalRiverPayments.createSource(payload).then( function(response) {
      if(response.error) {
        document.getElementById("response").innerHTML += "Payment response received error message: " + response.error.code + "" + JSON.stringify(response, null, '\t');
      } else {
        document.getElementById("response").innerHTML += "Payment response: " + "" + JSON.stringify(response.source, null, '\t');
      }
    }).catch(function (err) {
      console.error('createSource failed:', err);
    });
  }

  function commonGetSource(paymentType,currency) {
    event.preventDefault();

    const payload = {
      "type": paymentType,
      "owner": owner,
      "amount": 100,
      "currency": currency
    };

    if(paymentType == 'codJapan') {
      payload.codJapan = {
        "returnUrl": window.location.href
      }
    }else if(paymentType == 'payco') {
      payload.payco = {
        "returnUrl": window.location.href
      }
    }

    digitalRiverPayments.createSource(payload).then( function(response) {
      if(response.error) {
        document.getElementById("response").innerHTML += "Payment response received error message: " + response.error.code + "" + JSON.stringify(response, null, '\t');
      } else {
        document.getElementById("response").innerHTML += "Payment response: " + "" + JSON.stringify(response.source, null, '\t');
      }
    }).catch((err) => {
      console.error('createSource failed:', err);
    });
  }

  function destroyField() {
    $('#creditCardPanel').empty();
    creditCardNumberComponent.destroy();
    creditCardNumberComponent = '';
  }

  function recreateField() {
    $('#creditCardPanel').append('<div class="col-md-6 mb-3 paymentElement"> <label>Credit Card Number</label> <div id="ccError" class="text-danger"><!--error messages will go here--></div>' +
            '<div class="ccIcons"> <i id="VISA" class="fab fa-cc-visa"></i> <i id="MASTERCARD" class="fab fa-cc-mastercard"></i> <i id="AMERICAN_EXPRESS" class="fab fa-cc-amex"></i>' +
            '<i id="DISCOVER" class="fab fa-cc-discover"></i> <i id="JCB" class="fab fa-cc-jcb"></i> <i id="DINERS_CLUB" class="fab fa-cc-diners-club"></i>' +
            ' </div> <div id="cardnumber" class="myCustomClass"></div></div>');
    creditCardEvents();
  }

  function updateFields(obj) {
    if(obj.value == 'KR') {
      $('#city').val('Seoul');
      $('#state').val('Jeju Do');
      $('#zip').val('100-011');
    } else if(obj.value == 'JP') {
      $('#city').val('Chiba');
      $('#state').val('Kyongsangnamdo');
      $('#zip').val('272-0138');
    } else if(obj.value == 'FR') {
      $('#city').val('Paris');
      $('#state').val('Ile-de-France');
      $('#zip').val('75001');
    } else {
      $('#city').val('');
      $('#state').val('');
      $('#zip').val('');
    }
  }

</script>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
        integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
        integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>
</body>
</html>